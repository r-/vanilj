{"version":3,"file":"vanilj-plugin-store.min.umd.js","sources":["../src/store.js","../src/index.js"],"sourcesContent":["import { signal, effect } from '@vanilj/core'\r\n\r\nexport function createStore(initialState = {}, options = {}) {\r\n  const raw = {}\r\n  const subscribers = new Set()\r\n\r\n  for (const key in initialState) {\r\n    raw[key] = signal(initialState[key])\r\n  }\r\n\r\n  const state = {}\r\n  for (const key in raw) {\r\n    Object.defineProperty(state, key, {\r\n      get: () => raw[key].value\r\n    })\r\n  }\r\n\r\n  const notify = () => {\r\n    for (const fn of subscribers) fn(store)\r\n  }\r\n\r\n  const store = {\r\n    state: state,\r\n    raw,\r\n    snapshot: () => Object.fromEntries(Object.entries(raw).map(([k, s]) => [k, s.peek()])),\r\n    subscribe(fn) {\r\n      subscribers.add(fn)\r\n      return () => subscribers.delete(fn)\r\n    },\r\n    set(key, value) {\r\n      if (raw[key]) {\r\n        raw[key].value = value\r\n        notify()\r\n      }\r\n    },\r\n    update(fn) {\r\n      fn(store.state)\r\n      notify()\r\n    },\r\n    modules: {},\r\n    inspect: () => console.table(store.snapshot()),\r\n  }\r\n\r\n  return store\r\n}\r\n\r\nexport function usePersistedStore(store, { key = 'vanilj-store', session = false, exclude = [] } = {}) {\r\n  const storage = session ? sessionStorage : localStorage\r\n  const saved = storage.getItem(key)\r\n  if (saved) {\r\n    try {\r\n      const data = JSON.parse(saved)\r\n      for (const [k, v] of Object.entries(data)) {\r\n        // Skip excluded keys during restoration\r\n        if (store.raw[k] && !exclude.includes(k)) {\r\n          store.raw[k].value = v\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  effect(() => {\r\n    // Access the actual signal values to establish reactive dependencies\r\n    const snapshot = {}\r\n    for (const [key, signal] of Object.entries(store.raw)) {\r\n      if (!exclude.includes(key)) {\r\n        snapshot[key] = signal.value // This triggers reactivity tracking\r\n      }\r\n    }\r\n    storage.setItem(key, JSON.stringify(snapshot))\r\n  })\r\n}\r\n\r\nexport function useSyncedStore(store, { send, onReceive }) {\r\n  effect(() => {\r\n    const data = store.snapshot()\r\n    send(data)\r\n  })\r\n\r\n  onReceive((incoming) => {\r\n    for (const [k, v] of Object.entries(incoming)) {\r\n      if (store.raw[k]) store.raw[k].value = v\r\n    }\r\n  })\r\n}\r\n\r\nexport function useStoreDevtools(store, label = 'VaniljStore') {\r\n  let isLogging = false; // Prevent infinite loops\r\n  \r\n  effect(() => {\r\n    if (isLogging) return; // Guard against re-entry\r\n    \r\n    isLogging = true;\r\n    try {\r\n      // Access signal values to establish reactive dependencies\r\n      const snapshot = {};\r\n      for (const [key, signal] of Object.entries(store.raw)) {\r\n        snapshot[key] = signal.value;\r\n      }\r\n      \r\n      console.group(`[${label}] Update`);\r\n      console.table(snapshot);\r\n      console.groupEnd();\r\n    } finally {\r\n      isLogging = false;\r\n    }\r\n  });\r\n}\r\n\r\nexport function useUndoRedo(store, fields = null) {\r\n  const history = []\r\n  let pointer = -1\r\n\r\n  const snapshot = () => {\r\n    const snap = store.snapshot()\r\n    return fields ? Object.fromEntries(fields.map(f => [f, snap[f]])) : snap\r\n  }\r\n\r\n  const record = () => {\r\n    history.splice(pointer + 1)\r\n    history.push(snapshot())\r\n    pointer++\r\n  }\r\n\r\n  record()\r\n  store.subscribe(record)\r\n\r\n  return {\r\n    undo() {\r\n      if (pointer > 0) {\r\n        pointer--\r\n        for (const [k, v] of Object.entries(history[pointer])) {\r\n          if (store.raw[k]) store.raw[k].value = v\r\n        }\r\n      }\r\n    },\r\n    redo() {\r\n      if (pointer < history.length - 1) {\r\n        pointer++\r\n        for (const [k, v] of Object.entries(history[pointer])) {\r\n          if (store.raw[k]) store.raw[k].value = v\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function useMiddleware(store, fn) {\r\n  for (const [k, s] of Object.entries(store.raw)) {\r\n    const original = s.set\r\n    s.set = (v) => {\r\n      const old = s.peek()\r\n      const next = fn(k, v, old)\r\n      original.call(s, next)\r\n    }\r\n  }\r\n}\r\n\r\nexport function useThunkStore(store) {\r\n  const dispatch = (action) => {\r\n    if (typeof action === 'function') {\r\n      action(dispatch, store.state)\r\n    }\r\n  }\r\n  return dispatch\r\n}\r\n\r\nexport function createModuleStore(modules) {\r\n  const root = createStore()\r\n  for (const [name, definition] of Object.entries(modules)) {\r\n    const mod = createStore(definition.state || {})\r\n    root.modules[name] = mod\r\n  }\r\n  return root\r\n}\r\n","// packages/plugin-store/src/index.js - Store plugin entry point\r\n\r\n// Export the store functionality\r\nexport { \r\n  createStore, \r\n  usePersistedStore, \r\n  useSyncedStore, \r\n  useStoreDevtools, \r\n  useUndoRedo, \r\n  useMiddleware, \r\n  useThunkStore, \r\n  createModuleStore \r\n} from './store.js';\r\n\r\n// Auto-register notification when loaded via script tag\r\nif (typeof window !== 'undefined' && window.VaniljCore) {\r\n  console.log('Vanilj Store plugin loaded');\r\n}"],"names":["createStore","initialState","options","raw","subscribers","Set","key","signal","state","Object","defineProperty","get","value","notify","fn","store","snapshot","fromEntries","entries","map","k","s","peek","subscribe","add","delete","set","update","modules","inspect","console","table","window","VaniljCore","log","root","name","definition","mod","original","v","old","next","call","session","exclude","storage","sessionStorage","localStorage","saved","getItem","data","JSON","parse","includes","effect","setItem","stringify","label","isLogging","group","groupEnd","send","onReceive","incoming","dispatch","action","fields","history","pointer","record","splice","push","snap","f","undo","redo","length"],"mappings":"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"}