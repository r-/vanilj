{"version":3,"file":"vanilj-plugin-store.min.es.js","sources":["../src/store.js","../src/index.js"],"sourcesContent":["import { signal, effect } from '@vanilj/core'\r\n\r\nexport function createStore(initialState = {}, options = {}) {\r\n  const raw = {}\r\n  const subscribers = new Set()\r\n\r\n  for (const key in initialState) {\r\n    raw[key] = signal(initialState[key])\r\n  }\r\n\r\n  const state = {}\r\n  for (const key in raw) {\r\n    Object.defineProperty(state, key, {\r\n      get: () => raw[key].value\r\n    })\r\n  }\r\n\r\n  const notify = () => {\r\n    for (const fn of subscribers) fn(store)\r\n  }\r\n\r\n  const store = {\r\n    state: state,\r\n    raw,\r\n    snapshot: () => Object.fromEntries(Object.entries(raw).map(([k, s]) => [k, s.peek()])),\r\n    subscribe(fn) {\r\n      subscribers.add(fn)\r\n      return () => subscribers.delete(fn)\r\n    },\r\n    set(key, value) {\r\n      if (raw[key]) {\r\n        raw[key].value = value\r\n        notify()\r\n      }\r\n    },\r\n    update(fn) {\r\n      fn(store.state)\r\n      notify()\r\n    },\r\n    modules: {},\r\n    inspect: () => console.table(store.snapshot()),\r\n  }\r\n\r\n  return store\r\n}\r\n\r\nexport function usePersistedStore(store, { key = 'vanilj-store', session = false, exclude = [] } = {}) {\r\n  const storage = session ? sessionStorage : localStorage\r\n  const saved = storage.getItem(key)\r\n  if (saved) {\r\n    try {\r\n      const data = JSON.parse(saved)\r\n      for (const [k, v] of Object.entries(data)) {\r\n        // Skip excluded keys during restoration\r\n        if (store.raw[k] && !exclude.includes(k)) {\r\n          store.raw[k].value = v\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  effect(() => {\r\n    // Access the actual signal values to establish reactive dependencies\r\n    const snapshot = {}\r\n    for (const [key, signal] of Object.entries(store.raw)) {\r\n      if (!exclude.includes(key)) {\r\n        snapshot[key] = signal.value // This triggers reactivity tracking\r\n      }\r\n    }\r\n    storage.setItem(key, JSON.stringify(snapshot))\r\n  })\r\n}\r\n\r\nexport function useSyncedStore(store, { send, onReceive }) {\r\n  effect(() => {\r\n    const data = store.snapshot()\r\n    send(data)\r\n  })\r\n\r\n  onReceive((incoming) => {\r\n    for (const [k, v] of Object.entries(incoming)) {\r\n      if (store.raw[k]) store.raw[k].value = v\r\n    }\r\n  })\r\n}\r\n\r\nexport function useStoreDevtools(store, label = 'VaniljStore') {\r\n  let isLogging = false; // Prevent infinite loops\r\n  \r\n  effect(() => {\r\n    if (isLogging) return; // Guard against re-entry\r\n    \r\n    isLogging = true;\r\n    try {\r\n      // Access signal values to establish reactive dependencies\r\n      const snapshot = {};\r\n      for (const [key, signal] of Object.entries(store.raw)) {\r\n        snapshot[key] = signal.value;\r\n      }\r\n      \r\n      console.group(`[${label}] Update`);\r\n      console.table(snapshot);\r\n      console.groupEnd();\r\n    } finally {\r\n      isLogging = false;\r\n    }\r\n  });\r\n}\r\n\r\nexport function useUndoRedo(store, fields = null) {\r\n  const history = []\r\n  let pointer = -1\r\n\r\n  const snapshot = () => {\r\n    const snap = store.snapshot()\r\n    return fields ? Object.fromEntries(fields.map(f => [f, snap[f]])) : snap\r\n  }\r\n\r\n  const record = () => {\r\n    history.splice(pointer + 1)\r\n    history.push(snapshot())\r\n    pointer++\r\n  }\r\n\r\n  record()\r\n  store.subscribe(record)\r\n\r\n  return {\r\n    undo() {\r\n      if (pointer > 0) {\r\n        pointer--\r\n        for (const [k, v] of Object.entries(history[pointer])) {\r\n          if (store.raw[k]) store.raw[k].value = v\r\n        }\r\n      }\r\n    },\r\n    redo() {\r\n      if (pointer < history.length - 1) {\r\n        pointer++\r\n        for (const [k, v] of Object.entries(history[pointer])) {\r\n          if (store.raw[k]) store.raw[k].value = v\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function useMiddleware(store, fn) {\r\n  for (const [k, s] of Object.entries(store.raw)) {\r\n    const original = s.set\r\n    s.set = (v) => {\r\n      const old = s.peek()\r\n      const next = fn(k, v, old)\r\n      original.call(s, next)\r\n    }\r\n  }\r\n}\r\n\r\nexport function useThunkStore(store) {\r\n  const dispatch = (action) => {\r\n    if (typeof action === 'function') {\r\n      action(dispatch, store.state)\r\n    }\r\n  }\r\n  return dispatch\r\n}\r\n\r\nexport function createModuleStore(modules) {\r\n  const root = createStore()\r\n  for (const [name, definition] of Object.entries(modules)) {\r\n    const mod = createStore(definition.state || {})\r\n    root.modules[name] = mod\r\n  }\r\n  return root\r\n}\r\n","// packages/plugin-store/src/index.js - Store plugin entry point\r\n\r\n// Export the store functionality\r\nexport { \r\n  createStore, \r\n  usePersistedStore, \r\n  useSyncedStore, \r\n  useStoreDevtools, \r\n  useUndoRedo, \r\n  useMiddleware, \r\n  useThunkStore, \r\n  createModuleStore \r\n} from './store.js';\r\n\r\n// Auto-register notification when loaded via script tag\r\nif (typeof window !== 'undefined' && window.VaniljCore) {\r\n  console.log('Vanilj Store plugin loaded');\r\n}"],"names":["key","signal"],"mappings":"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"}